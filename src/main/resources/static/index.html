<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo dos Portos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .game-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 80vh;
        }

        .game-board {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .panel h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-card {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .player-card.blue { border-left-color: #3182ce; }
        .player-card.red { border-left-color: #e53e3e; }
        .player-card.green { border-left-color: #38a169; }
        .player-card.yellow { border-left-color: #d69e2e; }
        .player-card.purple { border-left-color: #805ad5; }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            color: #2d3748;
        }

        .player-resources {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 2px;
        }

        .port {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #4a5568;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .port:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .port.blue { background: #3182ce; }
        .port.red { background: #e53e3e; }
        .port.green { background: #38a169; }
        .port.yellow { background: #d69e2e; }
        .port.purple { background: #805ad5; }

        .route {
            position: absolute;
            height: 4px;
            background: #cbd5e0;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route:hover {
            height: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .route.blue { background: #3182ce; }
        .route.red { background: #e53e3e; }
        .route.green { background: #38a169; }
        .route.yellow { background: #d69e2e; }
        .route.purple { background: #805ad5; }

        .route.owned {
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-success {
            background: #38a169;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .question-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .question-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .question-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
            color: #4a5568;
        }

        .alternatives {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .alternative {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alternative:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .alternative.selected {
            border-color: #667eea;
            background: #ebf8ff;
        }

        .alternative-letter {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #38a169;
        }

        .notification.error {
            border-left: 4px solid #e53e3e;
        }

        .notification.info {
            border-left: 4px solid #3182ce;
        }

        .game-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #38a169;
        }

        .status-indicator.disconnected {
            background: #e53e3e;
        }

        .join-game-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .join-game-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .join-game-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 1024px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .game-board {
                padding: 20px;
            }
            
            .port {
                width: 30px;
                height: 30px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-anchor"></i> Jogo dos Portos</h1>
            <p>Estratégia naval com conhecimento geral</p>
        </div>

        <div class="game-container">
            <div class="game-board" id="gameBoard">
                <div class="game-controls">
                    <button class="btn" onclick="createGame()">
                        <i class="fas fa-plus"></i> Nova Partida
                    </button>
                    <button class="btn btn-secondary" onclick="getRandomQuestion()" id="questionBtn" disabled>
                        <i class="fas fa-question-circle"></i> Nova Pergunta
                    </button>
                    <button class="btn btn-success" onclick="nextTurn()" id="nextTurnBtn" disabled>
                        <i class="fas fa-forward"></i> Próximo Turno
                    </button>
                    <button class="btn" onclick="restartGame()" id="restartBtn" disabled>
                        <i class="fas fa-rotate-right"></i> Reiniciar
                    </button>
                    <button class="btn btn-danger" onclick="finishGame()" id="finishBtn" disabled>
                        <i class="fas fa-flag-checkered"></i> Finalizar
                    </button>
                </div>

                <div class="join-game-form" id="joinForm">
                    <input type="text" id="playerName" placeholder="Seu nome" maxlength="20">
                    <input type="number" id="gameId" placeholder="ID da partida" min="1">
                    <button class="btn" onclick="joinGame()">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>

                <div id="boardContent" style="position: relative; height: 500px; background: linear-gradient(45deg, #87CEEB 0%, #98FB98 100%); border-radius: 10px; margin-top: 20px;">
                    <!-- Portos e rotas serão inseridos aqui via JavaScript -->
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>
                        <i class="fas fa-users"></i>
                        Jogadores
                        <span class="status-indicator disconnected" id="connectionStatus"></span>
                    </h3>
                    <div class="player-list" id="playerList">
                        <p style="text-align: center; color: #718096; font-style: italic;">
                            Nenhum jogador conectado
                        </p>
                    </div>
                </div>

                <div class="panel">
                    <h3><i class="fas fa-gamepad"></i> Status do Jogo</h3>
                    <div id="gameStatus">
                        <p style="text-align: center; color: #718096; font-style: italic;">
                            Nenhuma partida ativa
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pergunta -->
    <div class="question-modal" id="questionModal">
        <div class="question-content">
            <div class="question-title">
                <i class="fas fa-question-circle"></i> Pergunta
            </div>
            <div class="question-text" id="questionText"></div>
            <div class="alternatives" id="alternatives"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="submitAnswer()" id="submitAnswerBtn" disabled>
                    <i class="fas fa-check"></i> Responder
                </button>
                <button class="btn btn-secondary" onclick="closeQuestionModal()" style="margin-left: 10px;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script>
        // Configuração WebSocket
        let stompClient = null;
        let currentGameId = null;
        let currentPlayerId = null;
        let selectedAlternative = null;
        let currentQuestion = null;
        let awaitingQuestion = false;
        let questionShown = false;
        let currentTurnIndex = 0; // índice do jogador atual (sincronizado com backend)
        let gameSubscription = null;

        // Conectar WebSocket
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: (str) => console.log(str),
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            stompClient.onConnect = (frame) => {
                console.log('Conectado: ' + frame);
                document.getElementById('connectionStatus').className = 'status-indicator connected';
                
                // Assina o tópico da partida atual, se já existir
                if (currentGameId) {
                    subscribeToGame(currentGameId);
                }
            };

            stompClient.onStompError = (frame) => {
                console.log('Erro STOMP: ' + frame.headers['message']);
                console.log('Detalhes: ' + frame.body);
                document.getElementById('connectionStatus').className = 'status-indicator disconnected';
            };

            stompClient.activate();
        }

        // Desconectar WebSocket
        function disconnect() {
            if (stompClient !== null) {
                stompClient.deactivate();
            }
            console.log("Desconectado");
            document.getElementById('connectionStatus').className = 'status-indicator disconnected';
        }

        // Conectar ao carregar a página
        window.onload = function() {
            connect();
            initializeBoard();
        };

        // Desconectar ao fechar a página
        window.onbeforeunload = function() {
            disconnect();
        };

        // Assinar tópico de uma partida específica
        function subscribeToGame(gameId) {
            if (!stompClient || !stompClient.connected) return;
            // cancelar assinatura anterior
            if (gameSubscription) {
                gameSubscription.unsubscribe();
                gameSubscription = null;
            }
            gameSubscription = stompClient.subscribe(`/topic/game/${gameId}`, (message) => {
                const data = JSON.parse(message.body);
                handleGameMessage(data);
            });
        }

        // Inicializar tabuleiro
        function initializeBoard() {
            const board = document.getElementById('boardContent');
            
            // Portos
            const ports = [
                { id: 1, name: 'Roterdã', x: 50, y: 100, color: 'blue' },
                { id: 2, name: 'Hamburgo', x: 150, y: 80, color: 'blue' },
                { id: 3, name: 'Antuérpia', x: 200, y: 120, color: 'blue' },
                { id: 4, name: 'Lisboa', x: 100, y: 200, color: 'blue' },
                { id: 5, name: 'Barcelona', x: 180, y: 180, color: 'red' },
                { id: 6, name: 'Marselha', x: 250, y: 160, color: 'red' },
                { id: 7, name: 'Gênova', x: 300, y: 140, color: 'red' },
                { id: 8, name: 'Nápoles', x: 320, y: 200, color: 'green' },
                { id: 9, name: 'Pireu', x: 350, y: 250, color: 'green' },
                { id: 10, name: 'Istambul', x: 400, y: 220, color: 'green' }
            ];

            ports.forEach(port => {
                const portElement = document.createElement('div');
                portElement.className = `port ${port.color}`;
                portElement.style.left = `${port.x}px`;
                portElement.style.top = `${port.y}px`;
                portElement.title = port.name;
                portElement.textContent = port.id;
                portElement.onclick = () => selectPort(port);
                board.appendChild(portElement);
            });

            // Rotas
            const routes = [
                { from: 1, to: 2, color: 'blue', cost: 15, points: 3 },
                { from: 2, to: 3, color: 'blue', cost: 12, points: 2 },
                { from: 3, to: 4, color: 'blue', cost: 20, points: 4 },
                { from: 4, to: 5, color: 'red', cost: 18, points: 3 },
                { from: 5, to: 6, color: 'red', cost: 15, points: 2 },
                { from: 6, to: 7, color: 'red', cost: 12, points: 2 },
                { from: 7, to: 8, color: 'green', cost: 10, points: 2 },
                { from: 8, to: 9, color: 'green', cost: 25, points: 5 },
                { from: 9, to: 10, color: 'green', cost: 30, points: 6 },
                { from: 1, to: 4, color: 'yellow', cost: 35, points: 7 },
                { from: 2, to: 5, color: 'yellow', cost: 28, points: 5 },
                { from: 3, to: 6, color: 'yellow', cost: 25, points: 4 },
                { from: 4, to: 7, color: 'purple', cost: 22, points: 4 },
                { from: 5, to: 8, color: 'purple', cost: 20, points: 3 },
                { from: 6, to: 9, color: 'purple', cost: 18, points: 3 }
            ];

            routes.forEach(route => {
                const fromPort = ports.find(p => p.id === route.from);
                const toPort = ports.find(p => p.id === route.to);
                
                if (fromPort && toPort) {
                    const routeElement = document.createElement('div');
                    routeElement.className = `route ${route.color}`;
                    
                    const angle = Math.atan2(toPort.y - fromPort.y, toPort.x - fromPort.x);
                    const length = Math.sqrt(Math.pow(toPort.x - fromPort.x, 2) + Math.pow(toPort.y - fromPort.y, 2));
                    
                    routeElement.style.left = `${fromPort.x + 20}px`;
                    routeElement.style.top = `${fromPort.y + 18}px`;
                    routeElement.style.width = `${length - 40}px`;
                    routeElement.style.transform = `rotate(${angle}rad)`;
                    routeElement.style.transformOrigin = '0 50%';
                    
                    routeElement.title = `Rota: ${fromPort.name} → ${toPort.name}\nCusto: $${route.cost} | Pontos: ${route.points}`;
                    routeElement.onclick = () => selectRoute(route, fromPort, toPort);
                    
                    board.appendChild(routeElement);
                }
            });
        }

        // Criar nova partida
        function createGame() {
            fetch('/api/games', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                currentGameId = data.id;
                showNotification('Nova partida criada! ID: ' + data.id, 'success');
                updateGameStatus('Partida criada - Aguardando jogadores');
                document.getElementById('gameId').value = data.id;
                updateGameControls(true, !!currentPlayerId);
                if (stompClient && stompClient.connected) {
                    subscribeToGame(currentGameId);
                }
            })
            .catch(error => {
                console.error('Erro ao criar partida:', error);
                showNotification('Erro ao criar partida', 'error');
            });
        }

        // Entrar na partida
        function joinGame() {
            const playerName = document.getElementById('playerName').value.trim();
            const gameId = document.getElementById('gameId').value;

            if (!playerName || !gameId) {
                showNotification('Preencha nome e ID da partida', 'error');
                return;
            }

            if (stompClient && stompClient.connected) {
                stompClient.publish({
                    destination: '/app/game/join',
                    body: JSON.stringify({
                        gameId: parseInt(gameId),
                        playerName: playerName
                    })
                });
                currentGameId = parseInt(gameId);
                subscribeToGame(currentGameId);
                updateGameControls(true, !!currentPlayerId);
            } else {
                // Fallback via REST se WebSocket ainda não conectou
                fetch(`/api/games/${parseInt(gameId)}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: playerName })
                })
                .then(r => {
                    if (!r.ok) throw new Error('Falha ao entrar na partida');
                    return r.json();
                })
                .then(player => {
                    currentGameId = parseInt(gameId);
                    currentPlayerId = player.id;
                    updatePlayerResources(player);
                    updateGameControls(true, true);
                    showNotification('Você entrou na partida!', 'success');
                    if (stompClient && stompClient.connected) {
                        subscribeToGame(currentGameId);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showNotification('Não foi possível entrar na partida', 'error');
                });
            }
        }

        // Próximo turno
        function nextTurn() {
            if (stompClient && stompClient.connected && currentGameId) {
                stompClient.publish({
                    destination: '/app/game/next-turn',
                    body: JSON.stringify({
                        gameId: currentGameId
                    })
                });
            }
        }

        // Obter pergunta aleatória
        function getRandomQuestion() {
            questionShown = false;
            awaitingQuestion = true;
            if (stompClient && stompClient.connected && currentGameId) {
                stompClient.publish({
                    destination: '/app/game/get-random-question',
                    body: JSON.stringify({
                        gameId: currentGameId
                    })
                });
                // Fallback por timeout se WS não entregar
                setTimeout(() => {
                    if (!questionShown) {
                        fetch('/api/questions/random')
                            .then(r => r.status === 204 ? null : r.json())
                            .then(q => { if (q) showQuestion(q); else showNotification('Sem perguntas disponíveis', 'error'); })
                            .catch(() => showNotification('Erro ao obter pergunta', 'error'))
                            .finally(() => { awaitingQuestion = false; });
                    }
                }, 800);
            } else {
                // Fallback REST: pega pergunta aleatória e abre modal direto
                fetch('/api/questions/random')
                    .then(r => r.status === 204 ? null : r.json())
                    .then(q => {
                        if (!q) {
                            showNotification('Sem perguntas disponíveis', 'error');
                            return;
                        }
                        showQuestion(q);
                    })
                    .catch(() => showNotification('Erro ao obter pergunta', 'error'))
                    .finally(() => { awaitingQuestion = false; });
            }
        }

        // Reiniciar jogo
        function restartGame() {
            if (stompClient && stompClient.connected && currentGameId) {
                stompClient.publish({
                    destination: '/app/game/restart',
                    body: JSON.stringify({
                        gameId: currentGameId
                    })
                });
            }
        }

        // Finalizar jogo
        function finishGame() {
            if (stompClient && stompClient.connected && currentGameId) {
                stompClient.publish({
                    destination: '/app/game/finish',
                    body: JSON.stringify({
                        gameId: currentGameId
                    })
                });
            }
        }

        // Processar mensagens do jogo
        function handleGameMessage(data) {
            console.log('Mensagem recebida:', data);

            switch (data.type) {
                case 'PLAYER_JOINED':
                    // Payload: { type, data: Player, gameId, playerId }
                    if (!currentGameId && data.gameId) {
                        currentGameId = data.gameId;
                        if (stompClient && stompClient.connected) subscribeToGame(currentGameId);
                    }
                    if (data.playerId) {
                        currentPlayerId = data.playerId;
                    }
                    if (data.data) {
                        // Se o jogador que entrou tem o mesmo nome do input, é o jogador atual
                        const playerName = document.getElementById('playerName').value;
                        if (data.data.name === playerName) {
                            currentPlayerId = data.data.id;
                        }
                        updatePlayerResources(data.data);
                    }
                    if (currentGameId) {
                        fetch(`/api/games/${currentGameId}`)
                            .then(r => r.ok ? r.json() : null)
                            .then(game => {
                                if (game && Array.isArray(game.players)) {
                                    updatePlayerList(game.players);
                                    updateGameStatus(game.status);
                                    updateGameControls(true, !!currentPlayerId);
                                }
                            })
                            .catch(() => {});
                    }
                    break;
                
                case 'TURN_CHANGED':
                    // Sincronizar índice de turno com backend
                    if (data.data.currentTurnIndex !== undefined) {
                        currentTurnIndex = data.data.currentTurnIndex;
                        console.log('Turno atualizado para índice:', currentTurnIndex);
                    }
                    updateGameStatus('Turno atualizado', data.data.players);
                    updatePlayerList(data.data.players);
                    showNotification('Novo turno iniciado! Todos receberam $10', 'info');
                    break;
                
                case 'NEW_QUESTION':
                    showQuestion(data.data.question);
                    break;
                
                case 'QUESTION_ANSWERED':
                    handleQuestionAnswer(data.data);
                    break;
                
                case 'GAME_FINISHED':
                    updateGameStatus('Partida finalizada');
                    showNotification('Partida finalizada!', 'info');
                    updateGameControls(false, false);
                    break;
                
                case 'GAME_UPDATE':
                    updatePlayerList(data.data.players);
                    updateGameStatus(data.data.status, data.data.players);
                    updateGameControls(!!currentGameId, !!currentPlayerId);
                    break;
                
                case 'ROUTE_PURCHASED':
                    showNotification('Rota comprada!', 'success');
                    break;
                
                case 'ERROR':
                    showNotification(data.message, 'error');
                    break;
            }
        }

        // Atualizar lista de jogadores
        function updatePlayerList(players) {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            if (!players || players.length === 0) {
                playerList.innerHTML = '<p style="text-align: center; color: #718096; font-style: italic;">Nenhum jogador conectado</p>';
                return;
            }

            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.cor?.nome?.toLowerCase() || 'blue'}`;
                
                playerCard.innerHTML = `
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-resources">
                            <i class="fas fa-coins"></i> $${player.dinheiro?.toFixed(0) || 0} | 
                            <i class="fas fa-ship"></i> ${player.naviosDisponiveis || 0} navios
                        </div>
                    </div>
                `;
                
                playerList.appendChild(playerCard);
            });
        }

        // Funções antigas removidas - agora tudo está no painel unificado

        // Atualizar status do jogo (agora inclui recursos do jogador atual)
        function updateGameStatus(status, players) {
            const statusDiv = document.getElementById('gameStatus');
            let statusText = status;
            let playerInfo = '';
            
            // Se temos lista de jogadores, mostra quem está no turno atual
            if (players && players.length > 0) {
                const currentPlayerAtTurn = players[currentTurnIndex % players.length];
                statusText += ` - Turno de: ${currentPlayerAtTurn.name}`;
                
                // Mostrar recursos do jogador atual da sessão
                if (currentPlayerId) {
                    const currentPlayer = players.find(p => p.id === currentPlayerId);
                    if (currentPlayer) {
                        const isCurrentTurn = currentPlayer.id === currentPlayerAtTurn.id;
                        playerInfo = `
                            <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: #2d3748; margin-bottom: 10px;">
                                    <i class="fas fa-user"></i> ${currentPlayer.name}
                                    ${isCurrentTurn ? 
                                        '<span style="background: #48bb78; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;"><i class="fas fa-play"></i> SEU TURNO</span>' : 
                                        '<span style="background: #e2e8f0; color: #4a5568; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;"><i class="fas fa-clock"></i> Aguardando</span>'
                                    }
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.8rem; color: #718096;">Dinheiro</div>
                                        <div style="font-weight: 600; color: #38a169;">$${currentPlayer.dinheiro?.toFixed(0) || 0}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.8rem; color: #718096;">Navios</div>
                                        <div style="font-weight: 600; color: #3182ce;">${currentPlayer.naviosDisponiveis || 0}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.8rem; color: #718096;">Rotas</div>
                                        <div style="font-weight: 600; color: #805ad5;">${currentPlayer.rotasPossuidas?.length || 0}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            statusDiv.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">
                        Status: ${statusText}
                    </div>
                    <div style="font-size: 0.9rem; color: #718096; margin-bottom: 10px;">
                        Partida ID: ${currentGameId || 'N/A'}
                    </div>
                    ${playerInfo}
                </div>
            `;
        }

        // Mostrar pergunta
        function showQuestion(question) {
            questionShown = true;
            awaitingQuestion = false;
            currentQuestion = question;
            document.getElementById('questionText').textContent = question.enunciado;
            
            const alternativesDiv = document.getElementById('alternatives');
            alternativesDiv.innerHTML = '';

            question.alternativas.forEach((alt, index) => {
                const altElement = document.createElement('div');
                altElement.className = 'alternative';
                altElement.innerHTML = `
                    <div class="alternative-letter">${alt.letra}</div>
                    <div>${alt.texto}</div>
                `;
                altElement.onclick = () => selectAlternative(altElement, alt);
                alternativesDiv.appendChild(altElement);
            });

            document.getElementById('questionModal').style.display = 'flex';
        }

        // Selecionar alternativa
        function selectAlternative(element, alternative) {
            // Remover seleção anterior
            document.querySelectorAll('.alternative').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Selecionar nova alternativa
            element.classList.add('selected');
            selectedAlternative = alternative;
            document.getElementById('submitAnswerBtn').disabled = false;
        }

        // Enviar resposta
        function submitAnswer() {
            if (!selectedAlternative || !currentQuestion || !currentPlayerId) {
                showNotification('Selecione uma alternativa', 'error');
                return;
            }

            if (stompClient && stompClient.connected && currentGameId) {
                stompClient.publish({
                    destination: '/app/game/answer-question',
                    body: JSON.stringify({
                        gameId: currentGameId,
                        playerId: currentPlayerId,
                        questionId: currentQuestion.id,
                        alternativeId: selectedAlternative.id
                    })
                });
            } else {
                // Fallback REST para responder
                fetch('/api/questions/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: currentPlayerId,
                        questionId: currentQuestion.id,
                        alternativeId: selectedAlternative.id
                    })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.correct) {
                        showNotification('Resposta correta! +$20', 'success');
                    } else {
                        showNotification('Resposta incorreta! -$5', 'error');
                    }
                    // Atualiza painel de jogadores se possível
                    if (currentGameId) {
                        fetch(`/api/games/${currentGameId}`)
                            .then(r => r.ok ? r.json() : null)
                            .then(game => {
                                if (game && Array.isArray(game.players)) {
                                    updatePlayerList(game.players);
                                }
                            }).catch(() => {});
                    }
                })
                .catch(() => showNotification('Erro ao enviar resposta', 'error'));
            }

            closeQuestionModal();
        }

        // Fechar modal de pergunta
        function closeQuestionModal() {
            document.getElementById('questionModal').style.display = 'none';
            selectedAlternative = null;
            currentQuestion = null;
            document.getElementById('submitAnswerBtn').disabled = true;
        }

        // Processar resposta da pergunta
        function handleQuestionAnswer(data) {
            if (data.correct) {
                showNotification('Resposta correta! +$20', 'success');
            } else {
                showNotification('Resposta incorreta! -$5', 'error');
            }
        }

        // Selecionar porto
        function selectPort(port) {
            showNotification(`Porto selecionado: ${port.name}`, 'info');
        }

        // Selecionar rota
        function selectRoute(route, fromPort, toPort) {
            if (!currentPlayerId) {
                showNotification('Entre em uma partida primeiro', 'error');
                return;
            }

            // Aqui você pode implementar a lógica de compra de rota
            showNotification(`Rota selecionada: ${fromPort.name} → ${toPort.name} ($${route.cost})`, 'info');
        }

        // Mostrar notificação
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Habilitar/desabilitar botões baseado no estado do jogo
        function updateGameControls(hasGame, isPlayer) {
            document.getElementById('questionBtn').disabled = !hasGame || !isPlayer;
            document.getElementById('nextTurnBtn').disabled = !hasGame || !isPlayer;
            document.getElementById('restartBtn').disabled = !hasGame || !isPlayer;
            document.getElementById('finishBtn').disabled = !hasGame || !isPlayer;
        }
    </script>
</body>
</html>
